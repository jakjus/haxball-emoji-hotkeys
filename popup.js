let emojiList = '😀 😃 😄 😁 😆 😅 🤣 😂 🙂 🙃 🫠 😉 😊 😇 🥰 😍 🤩 😘 😗 😚 😙 🥲  😛 😜 🤪 😝 🤑 🤗 🤭 🫢 🫣 🤫 🤔 🫡 🤐 🤨 😐 😑 😶 🫥 😏 😒 🙄 😬 🤥 😌 😔 😪 🤤 😴 😷 🤒 🤕 🤢 🤮 🤧 🥵 🥶 🥴 😵 🤯 🤠 🥳 🥸 😎 🤓 🧐 😕 🫤 😟 🙁 😮 😯 😲 😳 🥺 🥹 😦 😧 😨 😰 😥 😢 😭 😱 😖 😣 😞 😓 😩 😫 🥱 😤 😡 😠 🤬 😈 👿 💀 💩 🤡 👹 👺 👻 👽 👾 🤖 😺 😸 😹 😻 😼 😽 🙀 😿 😾 🙈 🙉 🙊 💋 💌 💘 💝 💖 💗 💓 💞 💕 💟 💔 🧡 💛 💚 💙 💜 🤎 🖤 🤍 💯 💢 💥 💫 💦 💨 💣 💬 💭 💤 👋 🤚 ✋ 🖖 🫱 🫲 🫳 🫴 👌 🤌 🤏 🤞 🫰 🤟 🤘 🤙 👈 👉 👆 🖕 👇 🫵 👍 👎 ✊ 👊 🤛 🤜 👏 🙌 🫶 👐 🤲 🤝 🙏 💅 🤳 💪 🦾 🦿 🦵 🦶 👂 🦻 👃 🧠 🫀 🫁 🦷 🦴 👀 👅 👄 🫦 👶 🧒 👦 👧 🧑 👱 👨 🧔 👩 🧓 👴 👵 🙍 🙎 🙅 🙆 💁 🙋 🧏 🙇 🤦 🤷 👮 💂 🥷 👷 🫅 🤴 👸 👳 👲 🧕 🤵 👰 🤰 🫃 🫄 🤱 👼 🎅 🤶 🦸 🦹 🧙 🧚 🧛 🧜 🧝 🧞 🧟 🧌 💆 💇 🚶 🧍 🧎 🏃 💃 🕺 👯 🧖 🧗 🤺 🏇 🏂 🏄 🚣 🏊 🚴 🚵 🤸 🤼 🤽 🤾 🤹 🧘 🛀 🛌 👭 👫 👬 💏 💑 👪 👤 👥 🫂 👣 🦰 🦱 🦳 🦲 🐵 🐒 🦍 🦧 🐶 🐕 🦮 🐩 🐺 🦊 🦝 🐱 🐈 🦁 🐯 🐅 🐆 🐴 🐎 🦄 🦓 🦌 🦬 🐮 🐂 🐃 🐄 🐷 🐖 🐗 🐽 🐏 🐑 🐐 🐪 🐫 🦙 🦒 🐘 🦣 🦏 🦛 🐭 🐁 🐀 🐹 🐰 🐇 🦫 🦔 🦇 🐻 🐨 🐼 🦥 🦦 🦨 🦘 🦡 🐾 🦃 🐔 🐓 🐣 🐤 🐥 🐦 🐧 🦅 🦆 🦢 🦉 🦤 🪶 🦩 🦚 🦜 🐸 🐊 🐢 🦎 🐍 🐲 🐉 🦕 🦖 🐳 🐋 🐬 🦭 🐟 🐠 🐡 🦈 🐙 🐚 🪸 🐌 🦋 🐛 🐜 🐝 🪲 🐞 🦗 🪳 🦂 🦟 🪰 🪱 🦠 💐 🌸 💮 🪷 🌹 🥀 🌺 🌻 🌼 🌷 🌱 🪴 🌲 🌳 🌴 🌵 🌾 🌿 🍀 🍁 🍂 🍃 🪹 🪺 🍇 🍈 🍉 🍊 🍋 🍌 🍍 🥭 🍎 🍏 🍐 🍑 🍒 🍓 🫐 🥝 🍅 🫒 🥥 🥑 🍆 🥔 🥕 🌽 🫑 🥒 🥬 🥦 🧄 🧅 🍄 🥜 🫘 🌰 🍞 🥐 🥖 🫓 🥨 🥯 🥞 🧇 🧀 🍖 🍗 🥩 🥓 🍔 🍟 🍕 🌭 🥪 🌮 🌯 🫔 🥙 🧆 🥚 🍳 🥘 🍲 🫕 🥣 🥗 🍿 🧈 🧂 🥫 🍱 🍘 🍙 🍚 🍛 🍜 🍝 🍠 🍢 🍣 🍤 🍥 🥮 🍡 🥟 🥠 🥡 🦀 🦞 🦐 🦑 🦪 🍦 🍧 🍨 🍩 🍪 🎂 🍰 🧁 🥧 🍫 🍬 🍭 🍮 🍯 🍼 🥛 ☕ 🫖 🍵 🍶 🍾 🍷 🍸 🍹 🍺 🍻 🥂 🥃 🫗 🥤 🧋 🧃 🧉 🧊 🥢 🍴 🥄 🔪 🫙 🏺 🌍 🌎 🌏 🌐 🗾 🧭 🌋 🗻 🧱 🪨 🪵 🛖 🏠 🏡 🏢 🏣 🏤 🏥 🏦 🏨 🏩 🏪 🏫 🏬 🏭 🏯 🏰 💒 🗼 🗽 ⛪ 🕌 🛕 🕍 🕋 ⛲ ⛺ 🌁 🌃 🌄 🌅 🌆 🌇 🌉 🎠 🛝 🎡 🎢 💈 🎪 🚂 🚃 🚄 🚅 🚆 🚇 🚈 🚉 🚊 🚝 🚞 🚋 🚌 🚍 🚎 🚐 🚑 🚒 🚓 🚔 🚕 🚖 🚗 🚘 🚙 🛻 🚚 🚛 🚜 🛵 🦽 🦼 🛺 🚲 🛴 🛹 🛼 🚏 ⛽ 🛞 🚨 🚥 🚦 🛑 🚧 ⚓ 🛟 ⛵ 🛶 🚤 🚢 🛫 🛬 🪂 💺 🚁 🚟 🚠 🚡 🚀 🛸 🧳 ⌛ ⏳ ⌚ ⏰ 🕛 🕧 🕐 🕜 🕑 🕝 🕒 🕞 🕓 🕟 🕔 🕠 🕕 🕡 🕖 🕢 🕗 🕣 🕘 🕤 🕙 🕥 🕚 🕦 🌑 🌒 🌓 🌔 🌕 🌖 🌗 🌘 🌙 🌚 🌛 🌜 🌝 🌞 🪐 ⭐ 🌟 🌠 🌌 ⛅ 🌀 🌈 🌂 ☔ ⚡ ⛄ 🔥 💧 🌊 🎃 🎄 🎆 🎇 🧨 ✨ 🎈 🎉 🎊 🎋 🎍 🎎 🎏 🎐 🎑 🧧 🎀 🎁 🎫 🏆 🏅 🥇 🥈 🥉 ⚽ ⚾ 🥎 🏀 🏐 🏈 🏉 🎾 🥏 🎳 🏏 🏑 🏒 🥍 🏓 🏸 🥊 🥋 🥅 ⛳ 🎣 🤿 🎽 🎿 🛷 🥌 🎯 🪀 🪁 🎱 🔮 🪄 🧿 🪬 🎮 🎰 🎲 🧩 🧸 🪅 🪩 🪆 🃏 🀄 🎴 🎭 🎨 🧵 🪡 🧶 🪢 👓 🥽 🥼 🦺 👔 👕 👖 🧣 🧤 🧥 🧦 👗 👘 🥻 🩱 🩲 🩳 👙 👚 👛 👜 👝 🎒 🩴 👞 👟 🥾 🥿 👠 👡 🩰 👢 👑 👒 🎩 🎓 🧢 🪖 📿 💄 💍 💎 🔇 🔈 🔉 🔊 📢 📣 📯 🔔 🔕 🎼 🎵 🎶 🎤 🎧 📻 🎷 🪗 🎸 🎹 🎺 🎻 🪕 🥁 🪘 📱 📲 📞 📟 📠 🔋 🪫 🔌 💻 💽 💾 💿 📀 🧮 🎥 🎬 📺 📷 📸 📹 📼 🔍 🔎 💡 🔦 🏮 🪔 📔 📕 📖 📗 📘 📙 📚 📓 📒 📃 📜 📄 📰 📑 🔖 💰 🪙 💴 💵 💶 💷 💸 💳 🧾 💹 📧 📨 📩 📤 📥 📦 📫 📪 📬 📭 📮 📝 💼 📁 📂 📅 📆 📇 📈 📉 📊 📋 📌 📍 📎 📏 📐 🔒 🔓 🔏 🔐 🔑 🔨 🪓 🔫 🪃 🏹 🪚 🔧 🪛 🔩 🦯 🔗 🪝 🧰 🧲 🪜 🧪 🧫 🧬 🔬 🔭 📡 💉 🩸 💊 🩹 🩼 🩺 🩻 🚪 🛗 🪞 🪟 🪑 🚽 🪠 🚿 🛁 🪤 🪒 🧴 🧷 🧹 🧺 🧻 🪣 🧼 🫧 🪥 🧽 🧯 🛒 🚬 🪦 🗿 🪧 🪪 🏧 🚮 🚰 ♿ 🚹 🚺 🚻 🚼 🚾 🛂 🛃 🛄 🛅 🚸 ⛔ 🚫 🚳 🚭 🚯 🚱 🚷 📵 🔞 🔃 🔄 🔙 🔚 🔛 🔜 🔝 🛐 🕎 🔯 ♈ ♉ ♊ ♋ ♌ ♍ ♎ ♏ ♐ ♑ ♒ ♓ ⛎ 🔀 🔁 🔂 ⏩ ⏪ 🔼 ⏫ 🔽 ⏬ 🎦 🔅 🔆 📶 📳 📴 ➕ ➖ ➗ 🟰 ❓ ❔ ❕ ❗ 💱 💲 🔱 📛 🔰 ⭕ ✅ ❌ ❎ ➰ ➿ 🔟 🔠 🔡 🔢 🔣 🔤 🆎 🆑 🆒 🆓 🆔 🆕 🆖 🆗 🆘 🆙 🆚 🈁 🈶 🈯 🉐 🈹 🈚 🈲 🉑 🈸 🈴 🈳 🈺 🈵 🔴 🟠 🟡 🟢 🔵 🟣 🟤 ⚫ ⚪ 🟥 🟧 🟨 🟩 🟦 🟪 🟫 ⬛ ⬜ ◾ ◽ 🔶 🔷 🔸 🔹 🔺 🔻 💠 🔘 🔳 🔲 🏁 🚩 🎌 🏴'

let emojiArray = emojiList.split(' ')

button = document.getElementById('addNewEmoji')

function handleKeyChange(e) {
  kk = e.target
  let prevKey = kk.innerText
  kk.innerText = 'Press a key'
  document.addEventListener('keydown', logKey)
  function logKey(e) {
    kk.innerText = e.code
    document.removeEventListener('keydown', logKey)
    let em = kk.parentElement.querySelector('.emoji').innerText
    chrome.storage.sync.get("emojis", ({ emojis })  => {
      delete emojis[prevKey]
      emojis[e.code] = em
      chrome.storage.sync.set({ emojis })
    })
  }
}

function addEmoji(text, key){
  chrome.storage.sync.get("emojis", ({ emojis }) => {
    emojis[key] = text
    chrome.storage.sync.set({ emojis })
  })
}

function addDOM(text, key){
  newEmoji = document.createElement("div")
  newEmoji.innerHTML = `<div class="hotkey"><span class="emoji">${text}</span><p class="key">${key}</p><img class="remove" src="images/x.png"></img></div>`
  container = document.getElementById('activeEmojis')
  container.appendChild(newEmoji)
  let kk = newEmoji.querySelector('.key')
  let x = newEmoji.querySelector('.remove')
  let eh = newEmoji.querySelector('.emoji')
  kk.addEventListener("click", handleKeyChange)
  x.addEventListener("click", handleRemove)
  eh.addEventListener("click", handleEmojiClick)
}

emojiNodes = []
emojiArray.map(e => {
  node = document.createElement("span")
  node.className = 'singleEmoji'
  node.innerHTML = e
  emojiNodes.push(node)
});

let chooserOpen = false

function chooseAndClose(e, eh, emojichooser) {
  let peh = eh.parentElement
  let choice = e.innerText || e.value  // It can be text or emoji
  peh.querySelector('.emoji').innerText = choice
  let currentKeyElem = peh.querySelector('.key')
  if (currentKeyElem){
    let currentKey = currentKeyElem.innerText
    chrome.storage.sync.get("emojis", ({ emojis })  => {
      emojis[currentKey] = e.innerText || e.value
      chrome.storage.sync.set({ emojis })
    })
  } else {
    chrome.storage.sync.get("defaultEmoji", ({ defaultEmoji })  => {
      defaultEmoji = e.innerText || e.value
      chrome.storage.sync.set({ defaultEmoji })
    })
  }
  chooserOpen = false; 
  emojichooser.remove();
}

function handleEmojiClick(e) {
  eh = e.target
  if (!chooserOpen){
    chooserOpen = !chooserOpen
    list = document.createElement("div")
    list.innerHTML = `<div class="emojichooser"><input id="textemoji"></input><img class="remove" src="images/x.png"></img></div>`
    input = list.querySelector('#textemoji')
    input.addEventListener("input", (e) => {
      if (e.target.value.length > 1){
        chooseAndClose(e.target, eh, input.parentElement)
      }
    })
    emojiNodes.map(emoji => {
      list.querySelector('.emojichooser').appendChild(emoji)
      emoji.addEventListener("click", (emojiInList) => {
        chooseAndClose(emojiInList.target, eh, emoji.parentElement)
      }) 
    })
    eh.parentElement.parentElement.parentElement.parentElement.appendChild(list)
    let x = list.querySelector('.remove')
    x.addEventListener("click", () => {chooserOpen = false; x.parentElement.remove()})
    return
  }
  if (chooserOpen){
    chooserOpen = false; eh.parentElement.parentElement.parentElement.parentElement.querySelector('.emojichooser').remove();
    return
  }
}

function handleRemove(e) {
  x = e.target
  chrome.storage.sync.get("emojis", ({ emojis }) => {
    delete emojis[x.parentElement.querySelector('.key').innerText]
    chrome.storage.sync.set({ emojis })
  })
  x.parentElement.remove()
}

function add(text, key){
  if (!text || !key) { text = ':)'; key = 'No key' }
  addDOM(text,key)
  addEmoji(text,key)
}

button.onclick = add

function view(){
  chrome.storage.sync.get("defaultEmoji", ({ defaultEmoji }) => {
    container = document.getElementById('defaultEmoji')
    container.innerText = defaultEmoji
    container.addEventListener("click", handleEmojiClick)
  })
  chrome.storage.sync.get("emojis", ({ emojis }) => {
    Object.keys(emojis).forEach(e => addDOM(emojis[e], e))
  })
}

view()
